{% extends "base.html" %}

{% block title %}Log · Deltatrade{% endblock %}
{% block header_title %}Execution log{% endblock %}

{% block content %}
<div class="card card-surface p-4 mb-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
    <div>
      <h5 class="fw-semibold mb-1">Episodes history</h5>
      <p class="text-muted small mb-0">
        Page {{ page }}{% if total_pages %} / {{ total_pages }}{% endif %} · showing {{ episodes|length }} entries ({{ start_index }}–{{ end_index }} of {{ total }})
      </p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('log_csv') }}">
        <i class="bi bi-download"></i>
        Export CSV
      </a>
      <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">Back to dashboard</a>
    </div>
  </div>
</div>

<div class="log-feed">
  {% if episodes %}
    {% for ep in episodes %}
      {% if ep.get('level') == 'ORDER' %}
        {% set payload = ep.get('payload', {}) or {} %}
        {% set result = payload.get('result', {}) or {} %}
        {% set clock = payload.get('clock', {}) or {} %}
        {% set action = payload.get('action', '') %}
        {% if action == 'manual_sell_all' %}
          {% set action_label = 'Manual sell all' %}
        {% else %}
          {% set action_label = 'Manual sell' %}
        {% endif %}
        {% set statuses = result.get('status', []) or [] %}
        {% set ok = result.get('ok') %}
        <article class="log-entry manual">
          <div class="log-header">
            <div class="log-time">{{ ep.as_of.replace('T', ' · ') }}</div>
            <span class="log-mode">Manual override</span>
            {% if clock.get('is_open') %}
              <span class="badge bg-primary-subtle text-primary-emphasis">Market open</span>
            {% elif clock.get('is_open') is not none %}
              <span class="badge bg-primary-subtle text-primary-emphasis">Market closed</span>
            {% endif %}
          </div>
          <div class="log-decision">
            <span class="decision-pill hold">Manual action</span>
            <p class="mb-0">Team triggered {{ action_label|lower }}{% if payload.get('symbol') %} on <strong>{{ payload.get('symbol') }}</strong>{% endif %}.</p>
            {% if payload.get('message') %}
            <p class="small text-muted mb-0">{{ payload.get('message') }}</p>
            {% endif %}
          </div>
          <div class="log-metrics">
            <div class="log-metric">
              <div class="label">Status</div>
              <div class="value {{ 'text-success' if ok else 'text-danger' }}">{{ 'Succeeded' if ok else 'Failed' }}</div>
            </div>
            {% if result.get('method') %}
            <div class="log-metric">
              <div class="label">Method</div>
              <div class="value">{{ result.get('method') }}</div>
            </div>
            {% endif %}
            {% if result.get('qty') %}
            <div class="log-metric">
              <div class="label">Quantity</div>
              <div class="value">{{ result.get('qty') }}</div>
            </div>
            {% endif %}
            {% if statuses %}
            <div class="log-metric">
              <div class="label">Order states</div>
              <div class="value small">
                {% for status in statuses %}
                  {% if status.get is defined %}
                    {{ status.get('symbol') }} ({{ status.get('status') }})
                  {% else %}
                    {{ status.symbol }} ({{ status.status }})
                  {% endif %}
                  {% if not loop.last %}, {% endif %}
                {% endfor %}
              </div>
            </div>
            {% endif %}
            {% if result.get('error') or result.get('fallback_error') %}
            <div class="log-metric">
              <div class="label">Errors</div>
              <div class="value small">{{ result.get('error') or result.get('fallback_error') }}</div>
            </div>
            {% endif %}
          </div>
        </article>
      {% else %}
        {% set gate = ep.get('gate', {}) or {} %}
        {% set diag = ep.get('diag', {}) or {} %}
        {% set stage = diag.get('stage', {}) or {} %}
        {% set filters = diag.get('filters', {}) or {} %}
        {% set preview = diag.get('planned_orders_preview', []) %}
        {% set mode_code = gate.get('mode', 'paper') %}
        {% if mode_code in ['live', 'realtime'] %}
          {% set mode_label = 'Live' %}
          {% set mode_class = 'live' %}
        {% elif mode_code in ['sim', 'simulated'] %}
          {% set mode_label = 'Simulated' %}
          {% set mode_class = 'simulated' %}
        {% else %}
          {% set mode_label = 'Paper' %}
          {% set mode_class = '' %}
        {% endif %}
        {% set expected = gate.get('expected_alpha_bps', ep.get('expected_alpha_bps', 0)) | float %}
        {% set cost = gate.get('cost_bps', ep.get('est_cost_bps', 0)) | float %}
        {% set net = gate.get('net_bps', ep.get('net_edge_bps', 0)) | float %}
        {% set turnover = gate.get('turnover_pct', 0) | float %}
        {% set cash_frac = gate.get('cash_frac', 0) | float %}
        {% set equity = gate.get('equity', ep.get('investable', 0)) | float %}
        {% set order_count = gate.get('order_count', ep.get('planned_orders_count', 0)) %}
        {% set reasons_list = gate.get('friendly_reasons') or ep.get('friendly_reasons') or [] %}
        {% if not reasons_list and gate.get('reason_primary_friendly') %}
          {% set reasons_list = [gate.get('reason_primary_friendly')] %}
        {% endif %}
        {% set orders_submitted = ep.orders_submitted or [] %}
        {% set order_ns = namespace(count=0) %}
        {% for oid in orders_submitted %}
          {% if oid != 'DRY_RUN_NO_ORDERS' %}
            {% set order_ns.count = order_ns.count + 1 %}
          {% endif %}
        {% endfor %}
        {% set traded = order_ns.count > 0 %}
        {% set decision_summary = ep.get('rebalance_summary') %}
        {% set risk_verdict = (ep.get('risk_officer_verdict') or {}) %}
        {% set risk_message = risk_verdict.get('message') or (ep.get('risk_officer') or {}).get('message') %}
        {% set net_class = 'text-success' if net > 0 else ('text-danger' if net < 0 else '') %}
        {% set top = (diag.get('top_candidates') or [])[:3] %}
        {% set exposure_diag = diag.get('exposure', {}) or {} %}
        {% set event_ai = (diag.get('event_ai') or ep.get('event_ai') or {}) %}
        {% set ai_summaries = event_ai.get('summaries') or [] %}
        {% set exposure_gate = gate.get('exposure', {}) or {} %}
        {% set sum_abs = exposure_diag.get('sum_abs_weights') or exposure_gate.get('sum_abs_weights') or exposure_gate.get('target_gross') or 0 %}
        <article class="log-entry">
          <div class="log-header">
            <div class="log-time">{{ ep.as_of.replace('T', ' · ') }}</div>
            <span class="log-mode {{ mode_class }}">{{ mode_label }}</span>
            {% if gate.get('model') %}<span class="badge bg-primary-subtle text-primary-emphasis">Model {{ gate.get('model') }}</span>{% endif %}
            {% if gate.get('effort') %}<span class="badge bg-primary-subtle text-primary-emphasis">Effort {{ gate.get('effort') }}</span>{% endif %}
          </div>
          <div class="log-decision">
            <span class="decision-pill {{ 'go' if gate.get('proceed') else 'hold' }}">{{ 'Trade approved' if gate.get('proceed') else 'Trade held' }}</span>
            {% if gate.get('proceed') %}
              {% if traded %}
                <p class="mb-0">AI sent {{ order_ns.count }} order{{ 's' if order_ns.count != 1 else '' }} with an expected edge of {{ '%.1f'|format(expected) }} bps and net {{ '%.1f'|format(net) }} bps.</p>
              {% else %}
                <p class="mb-0">AI approved trading (net {{ '%.1f'|format(net) }} bps) but no orders were dispatched.</p>
              {% endif %}
            {% else %}
              {% set reason_text = reasons_list|join(' ') if reasons_list else 'net edge was too small' %}
              <p class="mb-0">AI held positions steady because {{ reason_text }}.</p>
            {% endif %}
            {% if decision_summary %}
            <p class="small text-muted mb-0">Focus: {{ decision_summary }}.</p>
            {% endif %}
            {% if risk_message %}
            <p class="small text-muted mb-0">Risk officer: {{ risk_message }}</p>
            {% endif %}
          </div>
          <div class="log-metrics">
            <div class="log-metric">
              <div class="label">Expected α</div>
              <div class="value">{{ '%.1f'|format(expected) }} bps</div>
            </div>
            <div class="log-metric">
              <div class="label">Costs</div>
              <div class="value">{{ '%.1f'|format(cost) }} bps</div>
            </div>
            <div class="log-metric">
              <div class="label">Net edge</div>
              <div class="value {{ net_class }}">{{ '%.1f'|format(net) }} bps</div>
            </div>
            <div class="log-metric">
              <div class="label">Turnover</div>
              <div class="value">{{ '%.1f'|format(turnover) }}%</div>
            </div>
            <div class="log-metric">
              <div class="label">Orders</div>
              <div class="value">{{ order_count }}</div>
            </div>
            <div class="log-metric">
              <div class="label">Equity</div>
              <div class="value">{{ "${:,.0f}".format(equity) }}</div>
            </div>
            <div class="log-metric">
              <div class="label">Cash</div>
              <div class="value">{{ '%.1f'|format(cash_frac * 100) }}%</div>
            </div>
            <div class="log-metric">
              <div class="label">Exposure |w|</div>
              <div class="value">{{ '%.2f'|format(sum_abs|float) }}</div>
            </div>
          </div>
          {% if reasons_list %}
          <div class="log-tags mb-3">
            {% for reason in reasons_list %}
              <span class="badge">{{ reason }}</span>
            {% endfor %}
          </div>
          {% endif %}
          {% set market_story = ep.get('market_commentary') or diag.get('market_commentary') %}
          {% if market_story %}
          <div class="mt-3">
            <div class="text-muted small mb-1">AI market takeaway</div>
            <div class="log-llm-explain">{{ market_story }}</div>
          </div>
          {% endif %}
          {% if preview %}
          <div class="mt-2">
            <div class="text-muted small mb-1">Order plan</div>
            <div class="log-order-list">
              {% for order in preview %}
                <span class="status-pill neutral">{{ order.get('symbol') }} {{ order.get('side') }} {{ "${:,.0f}".format(order.get('notional', 0) | float) }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% if top %}
          <div class="mt-3">
            <div class="text-muted small mb-1">Top signals</div>
            <div class="d-flex flex-column gap-2">
              {% for item in top %}
              <div class="signal-card">
                <div class="signal-header"><strong>{{ item.get('symbol') }}</strong> · {{ '%.1f'|format(item.get('score', 0) | float) }} bps</div>
                <div class="signal-meta">Factor {{ '%.1f'|format(item.get('factor_bps', 0) | float) }} · Event {{ '%.1f'|format(item.get('event_bps', 0) | float) }}</div>
                {% if item.get('event_summary') %}
                <div class="signal-body text-muted">{{ item.get('event_summary') }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% if ai_summaries %}
          <div class="mt-3">
            <div class="text-muted small mb-1">AI event rationale</div>
            <div class="d-flex flex-column gap-2">
              {% for summary in ai_summaries[:6] %}
              <div class="log-llm-explain">{{ summary }}</div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          <div class="mt-3 text-muted small">
            Universe {{ stage.get('universe_count', 0) }}, symbols with bars {{ stage.get('symbols_with_bars', 0) }}, valid features {{ stage.get('valid_features', 0) }}. Filters removed: min {{ filters.get('min_notional_removed', 0) }}, turnover {{ filters.get('turnover_cap_removed', 0) }}, at-target {{ filters.get('already_at_target_removed', 0) }}.
          </div>
        </article>
      {% endif %}
    {% endfor %}
  {% else %}
    <div class="card card-surface p-4 text-center text-muted">No runs recorded yet.</div>
  {% endif %}
</div>

{% if page > 1 or has_more %}
<div class="pagination-nav">
  {% if page > 1 %}
  <a class="btn btn-outline-secondary" href="{{ url_for('log', page=page-1, limit=limit) }}"><i class="bi bi-arrow-left"></i> Previous</a>
  {% else %}
  <span></span>
  {% endif %}
  <div class="text-muted small">Page {{ page }}{% if total_pages %} of {{ total_pages }}{% endif %}</div>
  {% if has_more %}
  <a class="btn btn-outline-secondary" href="{{ url_for('log', page=page+1, limit=limit) }}">Next <i class="bi bi-arrow-right"></i></a>
  {% else %}
  <span></span>
  {% endif %}
</div>
{% endif %}
{% endblock %}
