{% extends "base.html" %}

{% block title %}Log · Deltatrade{% endblock %}
{% block header_title %}Execution log{% endblock %}

{% block content %}
<div class="card card-surface p-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
    <div>
      <h5 class="fw-semibold mb-1">Episodes history</h5>
      <p class="text-muted small mb-0">
        Page {{ page }}{% if total_pages %} / {{ total_pages }}{% endif %} · showing {{ episodes|length }} runs ({{ start_index }}–{{ end_index }} of {{ total }})
      </p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('log_csv') }}">
        <i class="bi bi-download"></i>
        Export CSV
      </a>
      <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">Back to dashboard</a>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-modern table-striped align-middle">
      <thead class="text-uppercase small text-muted">
        <tr>
          <th style="min-width: 180px;">As of</th>
          <th>Mode</th>
          <th class="text-center">Proceed</th>
          <th class="text-end">Orders</th>
          <th class="text-end">Turnover %</th>
          <th class="text-end">Expected α (bps)</th>
          <th class="text-end">Costs (bps)</th>
          <th class="text-end">Net (bps)</th>
          <th class="text-end">Equity</th>
          <th class="text-end">Cash %</th>
          <th style="min-width: 200px;">Reasons</th>
          <th style="min-width: 260px;">Diagnostics</th>
        </tr>
      </thead>
      <tbody>
        {% for ep in episodes %}
        {% if ep.level == 'ORDER' %}
        {% set data = ep.get('data', {}) or {} %}
        {% set result = data.get('result', {}) or {} %}
        {% set clock = data.get('clock', {}) or {} %}
        {% set action = data.get('action', ep.get('kind', 'manual_order')) %}
        {% set ok = result.get('ok') %}
        <tr class="table-warning">
          <td>{{ ep.as_of or ep.timestamp or data.get('timestamp') }}</td>
          <td colspan="11">
            <div class="d-flex flex-column gap-1">
              <div class="fw-semibold {{ 'text-success' if ok else 'text-danger' }}">{{ action.replace('_', ' ')|title }} — {{ 'Success' if ok else 'Failed' }}</div>
              {% if data.symbol %}
              <div><span class="text-muted">Symbol:</span> {{ data.symbol }}</div>
              {% endif %}
              {% if result.method or result.qty %}
              <div><span class="text-muted">Method:</span> {{ result.method or 'n/a' }}{% if result.qty %} · qty={{ result.qty }}{% endif %}</div>
              {% endif %}
              {% if result.status %}
              <div><span class="text-muted">Statuses:</span>
                {% for item in result.status %}
                  {{ item.symbol }} → {{ item.status }}{% if item.qty %} (qty={{ item.qty }}){% endif %}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </div>
              {% endif %}
              {% if result.errors %}
              <div class="text-danger"><span class="text-muted">Errors:</span>
                {% for item in result.errors %}
                  {{ item.symbol }} → {{ item.error }}{% if not loop.last %}; {% endif %}
                {% endfor %}
              </div>
              {% elif result.error %}
              <div class="text-danger"><span class="text-muted">Error:</span> {{ result.error }}</div>
              {% endif %}
              {% if result.fallback_error %}
              <div class="text-muted">Fallback: {{ result.fallback_error }}</div>
              {% endif %}
              {% if data.message %}
              <div>{{ data.message }}</div>
              {% endif %}
              {% if clock %}
              <div class="text-muted small">
                {% set open_state = clock.get('is_open') %}
                <span>Market open: {% if open_state is none %}unknown{% elif open_state %}yes{% else %}no{% endif %}</span>
                {% if clock.get('next_open') %} · next open {{ clock.get('next_open') }}{% endif %}
                {% if clock.get('next_close') %} · next close {{ clock.get('next_close') }}{% endif %}
              </div>
              {% endif %}
            </div>
          </td>
        </tr>
        {% continue %}
        {% endif %}
        {% set gate = ep.get('gate', {}) or {} %}
        {% set diag = ep.get('diag', {}) or {} %}
        {% set stage = diag.get('stage', {}) or {} %}
        {% set filters = diag.get('filters', {}) or {} %}
        {% set preview = diag.get('planned_orders_preview', []) %}
        {% set mode_code = gate.get('mode', 'paper') %}
        {% if mode_code in ['live', 'realtime'] %}
          {% set mode_label = 'Live' %}
        {% elif mode_code in ['sim', 'simulated'] %}
          {% set mode_label = 'Simulated' %}
        {% else %}
          {% set mode_label = 'Paper' %}
        {% endif %}
        {% set expected = gate.get('expected_alpha_bps', ep.get('expected_alpha_bps', 0)) | float %}
        {% set cost = gate.get('cost_bps', ep.get('est_cost_bps', 0)) | float %}
        {% set net = gate.get('net_bps', ep.get('net_edge_bps', 0)) | float %}
        {% set turnover = gate.get('turnover_pct', 0) | float %}
        {% set cash_frac = gate.get('cash_frac', 0) | float %}
        {% set equity = gate.get('equity', 0) | float %}
        {% set order_count = gate.get('order_count', ep.get('planned_orders_count', 0)) %}
        {% set reasons_list = gate.get('reasons') if gate.get('reasons') else [] %}
        {% if not reasons_list and ep.gate_reason %}
          {% set reasons_list = [ep.gate_reason] %}
        {% endif %}
        {% set orders_submitted = ep.orders_submitted or [] %}
        {% set traded = orders_submitted and orders_submitted[0] != 'DRY_RUN_NO_ORDERS' %}
        {% set net_class = 'text-success' if net > 0 else ('text-danger' if net < 0 else '') %}
        <tr>
          <td>{{ ep.as_of }}</td>
          <td>{{ mode_label }}</td>
          <td class="text-center">
            {% if gate.get('proceed') %}
            <span class="status-pill"><i class="bi bi-check-circle"></i>Go</span>
            {% else %}
            <span class="status-pill negative"><i class="bi bi-x-circle"></i>Hold</span>
            {% endif %}
            <div class="small text-muted mt-1">
              {% if traded %}
                Orders sent
              {% elif ep.proceed %}
                Proceeded
              {% else %}
                Skipped
              {% endif %}
            </div>
          </td>
          <td class="text-end">{{ order_count }}</td>
          <td class="text-end">{{ '%.1f'|format(turnover) }}%</td>
          <td class="text-end">{{ '%.1f'|format(expected) }}</td>
          <td class="text-end">{{ '%.1f'|format(cost) }}</td>
          <td class="text-end"><span class="{{ net_class }}">{{ '%.1f'|format(net) }}</span></td>
          <td class="text-end">{{ "${:,.0f}".format(equity) }}</td>
          <td class="text-end">{{ '%.1f'|format(cash_frac * 100) }}%</td>
          <td class="small">
            {% if reasons_list %}
              {{ reasons_list|join(', ') }}
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td class="small">
            <div><span class="text-muted">Universe:</span> {{ stage.get('universe_count', 0) }} · Bars: {{ stage.get('symbols_with_bars', 0) }} · Features: {{ stage.get('valid_features', 0) }}</div>
            <div><span class="text-muted">Candidates:</span> {{ stage.get('candidates_topN', 0) }} · Opt nonzero: {{ stage.get('optimizer_nonzero', 0) }}</div>
            {% set top = (diag.get('top_candidates') or [])[:3] %}
            {% if top %}
            <div><span class="text-muted">Top:</span> {% for item in top %}{{ item.get('symbol') }} ({{ '%.1f'|format(item.get('score', 0) | float) }}){% if not loop.last %}, {% endif %}{% endfor %}</div>
            {% endif %}
            <div><span class="text-muted">Filters:</span> min {{ filters.get('min_notional_removed', 0) }}, turnover {{ filters.get('turnover_cap_removed', 0) }}, target {{ filters.get('already_at_target_removed', 0) }}</div>
            {% if preview %}
            <div><span class="text-muted">Orders:</span>
              {% for order in preview %}
                {{ order.get('symbol') }} ({{ order.get('side') }} {{ "${:,.0f}".format(order.get('notional', 0) | float) }}){% if not loop.last %}, {% endif %}
              {% endfor %}
            </div>
            {% else %}
            <div><span class="text-muted">Orders:</span> —</div>
            {% endif %}
            {% set exposure_diag = diag.get('exposure', {}) or {} %}
            {% set exposure_gate = gate.get('exposure', {}) or {} %}
            {% set sum_abs = exposure_diag.get('sum_abs_weights') or exposure_gate.get('sum_abs_weights') or exposure_gate.get('target_gross') or 0 %}
            <div><span class="text-muted">Exposure |w|:</span> {{ '%.2f'|format(sum_abs|float) }}</div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="12" class="text-center text-muted py-4">No runs recorded yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-between align-items-center mt-3">
    <div class="text-muted small">Page {{ page }}{% if total_pages %} / {{ total_pages }}{% endif %}</div>
    <div class="d-flex gap-2">
      {% if page > 1 %}
        <a class="btn btn-outline-secondary" href="{{ url_for('log', page=page-1, limit=limit) }}">Previous</a>
      {% endif %}
      {% if has_more %}
        <a class="btn btn-primary" href="{{ url_for('log', page=page+1, limit=limit) }}">Load more</a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
