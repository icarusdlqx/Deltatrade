{% extends "base.html" %}

{% block title %}Log · Deltatrade{% endblock %}
{% block header_title %}Execution log{% endblock %}
{% block header_lead %}
<p class="page-subtitle">A detailed trail of what the AI decided, why it traded or held back, and how manual overrides were handled.</p>
{% endblock %}

{% block content %}
<div class="card-surface p-4 mb-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
    <div>
      <div class="section-title mb-1">Episodes history</div>
      <p class="text-muted small mb-0">Page {{ page }}{% if total_pages %} / {{ total_pages }}{% endif %} · showing {{ episodes|length }} runs ({{ start_index }}–{{ end_index }} of {{ total }})</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary d-flex align-items-center gap-2" href="{{ url_for('log_csv') }}">
        <i class="bi bi-download"></i>
        Export CSV
      </a>
      <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">Back to dashboard</a>
    </div>
  </div>
</div>

<div class="timeline">
  {% for ep in episodes %}
  {% if ep.get('level') == 'ORDER' %}
  {% set payload = ep.get('payload', {}) or {} %}
  {% set result = payload.get('result', {}) or {} %}
  {% set clock = payload.get('clock', {}) or {} %}
  {% set statuses = result.get('status', []) or [] %}
  {% set action = payload.get('action', '') %}
  {% if action == 'manual_sell_all' %}
    {% set action_label = 'Manual sell all' %}
  {% else %}
    {% set action_label = 'Manual sell' %}
  {% endif %}
  <div class="timeline-item">
    <span class="timeline-marker neutral"><i class="bi bi-person"></i></span>
    <div class="decision-card">
      <div class="decision-header">
        <div>
          <h5 class="mb-1">{{ action_label }}</h5>
          <div class="text-muted small">{{ ep.as_of }}</div>
        </div>
        <div class="badge-soft neutral">Manual intervention</div>
      </div>
      <p class="text-muted small mb-3">
        {% if clock.get('is_open') %}
          Market open at action time.
        {% elif clock.get('is_open') is not none %}
          Market closed{% if clock.get('next_open') %} · next open {{ clock.get('next_open') }}{% endif %}.
        {% else %}
          Market status unavailable.
        {% endif %}
      </p>
      {% if payload.get('symbol') %}
      <div class="decision-section">
        <h6>Symbol</h6>
        <span class="decision-chip">{{ payload.get('symbol') }}</span>
      </div>
      {% endif %}
      <div class="decision-section">
        <h6>Outcome</h6>
        <div class="text-muted small">
          {% if result.get('ok') %}
            <span class="text-success fw-semibold">Success</span>
          {% else %}
            <span class="text-danger fw-semibold">Failed</span>
          {% endif %}
          {% if result.get('method') %} · Method: {{ result.get('method') }}{% endif %}
          {% if result.get('qty') %} · Qty: {{ result.get('qty') }}{% endif %}
          {% if result.get('error') %} · Error: {{ result.get('error') }}{% endif %}
          {% if result.get('fallback_error') %} · Fallback: {{ result.get('fallback_error') }}{% endif %}
        </div>
      </div>
      {% if statuses %}
      <div class="decision-section">
        <h6>Order statuses</h6>
        <div class="decision-chip-list">
          {% for status in statuses %}
            {% if status.get is defined %}
              {% set status_symbol = status.get('symbol') %}
              {% set status_value = status.get('status') %}
            {% else %}
              {% set status_symbol = status.symbol %}
              {% set status_value = status.status %}
            {% endif %}
            <span class="decision-chip">{{ status_symbol }} ({{ status_value }})</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      {% if payload.get('message') %}
      <div class="decision-section">
        <h6>Notes</h6>
        <p class="text-muted small mb-0">{{ payload.get('message') }}</p>
      </div>
      {% endif %}
    </div>
  </div>
  {% else %}
  {% set gate = ep.get('gate', {}) or {} %}
  {% set diag = ep.get('diag', {}) or {} %}
  {% set stage = diag.get('stage', {}) or {} %}
  {% set filters = diag.get('filters', {}) or {} %}
  {% set preview = diag.get('planned_orders_preview', []) %}
  {% set mode_code = gate.get('mode', 'paper') %}
  {% if mode_code in ['live', 'realtime'] %}
    {% set mode_label = 'Live' %}
  {% elif mode_code in ['sim', 'simulated'] %}
    {% set mode_label = 'Simulated' %}
  {% else %}
    {% set mode_label = 'Paper' %}
  {% endif %}
  {% set expected = gate.get('expected_alpha_bps', ep.get('expected_alpha_bps', 0)) | float %}
  {% set cost = gate.get('cost_bps', ep.get('est_cost_bps', 0)) | float %}
  {% set net = gate.get('net_bps', ep.get('net_edge_bps', 0)) | float %}
  {% set turnover = gate.get('turnover_pct', 0) | float %}
  {% set cash_frac = gate.get('cash_frac', 0) | float %}
  {% set equity = gate.get('equity', 0) | float %}
  {% set order_count = gate.get('order_count', ep.get('planned_orders_count', 0)) %}
  {% set reasons_list = gate.get('reasons') if gate.get('reasons') else [] %}
  {% if not reasons_list and ep.gate_reason %}
    {% set reasons_list = [ep.gate_reason] %}
  {% endif %}
  {% set orders_submitted = ep.orders_submitted or [] %}
  {% set traded = orders_submitted and orders_submitted[0] != 'DRY_RUN_NO_ORDERS' %}
  {% set net_class = 'text-success' if net > 0 else ('text-danger' if net < 0 else '') %}
  {% set plain_text = ep.get('plain_english') or gate.get('plain_english') or ep.get('summary') or '' %}
  {% set top = (diag.get('top_candidates') or [])[:5] %}
  {% set exposure_diag = diag.get('exposure', {}) or {} %}
  {% set sum_abs = exposure_diag.get('sum_abs_weights') or gate.get('exposure', {}).get('sum_abs_weights') or gate.get('exposure', {}).get('target_gross') or 0 %}
  <div class="timeline-item">
    <span class="timeline-marker {% if gate.get('proceed') %}{{ '' }}{% else %}negative{% endif %}">
      {% if gate.get('proceed') %}<i class="bi bi-check"></i>{% else %}<i class="bi bi-slash-circle"></i>{% endif %}
    </span>
    <div class="decision-card">
      <div class="decision-header">
        <div>
          <h5 class="mb-1">{{ ep.as_of }}</h5>
          <div class="text-muted small">Mode: {{ mode_label }} · {{ 'Orders sent' if traded else ('Proceeded' if ep.proceed else 'Skipped') }}</div>
        </div>
        {% if gate.get('proceed') %}
        <span class="badge-soft success">Proceed</span>
        {% else %}
        <span class="badge-soft danger">Hold</span>
        {% endif %}
      </div>
      <div class="decision-metrics">
        <div class="metric">
          <div class="metric-label">Expected α</div>
          <div class="metric-value">{{ '%.1f'|format(expected) }} bps</div>
        </div>
        <div class="metric">
          <div class="metric-label">Costs</div>
          <div class="metric-value text-danger">{{ '%.1f'|format(cost) }} bps</div>
        </div>
        <div class="metric">
          <div class="metric-label">Net edge</div>
          <div class="metric-value {{ net_class }}">{{ '%.1f'|format(net) }} bps</div>
        </div>
        <div class="metric">
          <div class="metric-label">Turnover</div>
          <div class="metric-value">{{ '%.1f'|format(turnover) }}%</div>
        </div>
        <div class="metric">
          <div class="metric-label">Orders</div>
          <div class="metric-value">{{ order_count }}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Equity</div>
          <div class="metric-value">{{ "${:,.0f}".format(equity) }}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Cash %</div>
          <div class="metric-value">{{ '%.1f'|format(cash_frac * 100) }}%</div>
        </div>
        <div class="metric">
          <div class="metric-label">Exposure |w|</div>
          <div class="metric-value">{{ '%.2f'|format(sum_abs|float) }}</div>
        </div>
      </div>
      {% if plain_text %}
      <div class="decision-section">
        <h6>AI narrative</h6>
        <p class="text-muted small mb-0">{{ plain_text }}</p>
      </div>
      {% endif %}
      {% if top %}
      <div class="decision-section">
        <h6>Top AI signals</h6>
        <div class="decision-chip-list">
          {% for item in top %}
          <span class="decision-chip">{{ item.get('symbol') }} ({{ '%.1f'|format(item.get('score', 0) | float) }})</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      {% if preview %}
      <div class="decision-section">
        <h6>Planned orders</h6>
        <div class="decision-chip-list">
          {% for order in preview %}
          <span class="decision-chip">{{ order.get('symbol') }} {{ order.get('side') }} {{ "${:,.0f}".format(order.get('notional', 0) | float) }}</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      {% if reasons_list %}
      <div class="decision-section">
        <h6>Gate reasons</h6>
        <div class="decision-chip-list">
          {% for reason in reasons_list %}
          <span class="decision-chip">{{ reason }}</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      <div class="decision-section">
        <h6>Universe &amp; filters</h6>
        <div class="text-muted small">
          Universe: {{ stage.get('universe_count', 0) }} · Bars: {{ stage.get('symbols_with_bars', 0) }} · Features: {{ stage.get('valid_features', 0) }}.<br>
          Candidates: {{ stage.get('candidates_topN', 0) }} · Opt nonzero: {{ stage.get('optimizer_nonzero', 0) }}.<br>
          Target slots: K={{ stage.get('target_positions', 0) }} · Pre={{ stage.get('nonzero_pre', stage.get('optimizer_nonzero', 0)) }} · Post={{ stage.get('nonzero_post', 0) }} · Fill={{ stage.get('fill_count', 0) }}.<br>
          Filters: min {{ filters.get('min_notional_removed', 0) }}, turnover {{ filters.get('turnover_cap_removed', 0) }}, target {{ filters.get('already_at_target_removed', 0) }}.
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% else %}
  <div class="timeline-item">
    <span class="timeline-marker neutral"><i class="bi bi-robot"></i></span>
    <div class="decision-card">
      <p class="text-muted mb-0">No runs recorded yet.</p>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}
