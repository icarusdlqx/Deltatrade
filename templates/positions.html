{% extends "base.html" %}

{% block title %}Positions Â· Deltatrade{% endblock %}
{% block header_title %}Portfolio positions{% endblock %}
{% block header_lead %}
<p class="page-subtitle">Monitor live exposure, review every open name, and trigger manual exits when needed.</p>
{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-12 col-xl-4">
    <div class="card-surface p-4 h-100">
      <div class="section-title">Exposure snapshot</div>
      <p class="text-muted small mb-4">Latest account information refreshed from the connected trading client.</p>
      <dl class="row g-3 detail-list mb-0">
        <dt class="col-6 text-muted">Total account value</dt>
        <dd class="col-6 fw-semibold">${{ '%.2f'|format(snapshot.equity|default(0)) }}</dd>
        <dt class="col-6 text-muted">Available cash</dt>
        <dd class="col-6">${{ '%.2f'|format(snapshot.cash|default(0)) }}</dd>
        <dt class="col-6 text-muted">Invested value</dt>
        <dd class="col-6">${{ '%.2f'|format((snapshot.equity|default(0)) - (snapshot.cash|default(0))) }}</dd>
        <dt class="col-6 text-muted">Mode</dt>
        <dd class="col-6">{{ 'Simulated account' if snapshot.simulated else env.mode_label }}</dd>
      </dl>
      {% if snapshot.error %}
      <div class="alert alert-warning mt-4 mb-0" role="alert">
        {{ snapshot.error }}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="col-12 col-xl-8">
    <div class="card-surface p-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
        <div class="d-flex align-items-center gap-2">
          <h5 class="fw-semibold mb-0">Active positions</h5>
          {% if snapshot.simulated %}
          <span class="badge-soft neutral">Simulation</span>
          {% endif %}
        </div>
        {% if snapshot.positions %}
        <button type="button" class="btn btn-outline-danger btn-sm js-sell-all d-flex align-items-center gap-2">
          <i class="bi bi-x-octagon"></i>
          Close all positions
        </button>
        {% endif %}
      </div>
      {% if message %}
      <div class="alert alert-{{ 'danger' if status == 'error' else 'success' }}" role="alert">
        {{ message }}
      </div>
      {% endif %}
      <small class="text-muted d-block mb-3">Any manual exits will be captured in the system log with the AI's subsequent rationale.</small>
      <div class="table-responsive">
        <table class="table table-modern positions-table align-middle mb-0">
          <thead>
            <tr>
              <th>Symbol</th>
              <th class="text-end">Quantity</th>
              <th class="text-end">Avg price</th>
              <th class="text-end">Last</th>
              <th class="text-end">Market value</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for pos in snapshot.positions %}
            <tr>
              <td class="fw-semibold">{{ pos.symbol }}</td>
              <td class="text-end">{{ '%.4f'|format(pos.qty) }}</td>
              <td class="text-end">${{ '%.2f'|format(pos.avg_price) }}</td>
              <td class="text-end">${{ '%.2f'|format(pos.current_price) }}</td>
              <td class="text-end">${{ '%.2f'|format(pos.market_value) }}</td>
              <td class="text-end">
                <button type="button" class="btn btn-outline-danger btn-sm js-sell" data-symbol="{{ pos.symbol }}">
                  Sell
                </button>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">No active positions.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
async function refreshPositions() {
  window.location.reload();
}

async function postJSON(url, body) {
  const res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(body || {}),
  });
  let data = {};
  try {
    data = await res.json();
  } catch (err) {
    data = {};
  }
  if (!res.ok) {
    const err = new Error(data.message || res.statusText || "Request failed");
    err.data = data;
    throw err;
  }
  return data;
}

document.addEventListener("click", async (event) => {
  const target = event.target.closest(".js-sell, .js-sell-all");
  if (!target) return;

  if (target.classList.contains("js-sell")) {
    const symbol = target.dataset.symbol;
    if (!symbol) {
      alert("Sell: missing symbol");
      return;
    }
    target.disabled = true;
    try {
      const data = await postJSON("/positions/sell", { symbol });
      const message = data.message || `Sell ${symbol}: ${data.ok ? "submitted" : "failed"}`;
      alert(message);
      await refreshPositions();
    } catch (error) {
      const serverMessage = (error.data && error.data.message) || error.message;
      alert(`Sell ${symbol}: ${serverMessage}`);
      await refreshPositions();
    } finally {
      target.disabled = false;
    }
  }

  if (target.classList.contains("js-sell-all")) {
    if (!confirm("Close ALL positions? This will submit market orders.")) {
      return;
    }
    target.disabled = true;
    try {
      const data = await postJSON("/positions/sell_all");
      const message = data.message || (data.ok ? "Sell all: submitted" : "Sell all: failed");
      alert(message);
      await refreshPositions();
    } catch (error) {
      const serverMessage = (error.data && error.data.message) || error.message;
      alert(`Sell all: ${serverMessage}`);
      await refreshPositions();
    } finally {
      target.disabled = false;
    }
  }
});
</script>
{% endblock %}
