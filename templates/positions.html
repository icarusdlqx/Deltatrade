{% extends "base.html" %}

{% block title %}Positions Â· Deltatrade{% endblock %}
{% block header_title %}Portfolio positions{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-12 col-xl-4">
    <div class="card card-surface p-4 h-100">
      <h5 class="fw-semibold">Exposure snapshot</h5>
      <p class="text-muted small mb-4">Latest equity snapshot refreshed from the trading client.</p>
      <dl class="row small mb-0">
        <dt class="col-6 text-muted">Total Account Value</dt>
        <dd class="col-6 fw-bold">${{ '%.2f'|format(snapshot.equity|default(0)) }}</dd>
        <dt class="col-6 text-muted">Available Cash</dt>
        <dd class="col-6">${{ '%.2f'|format(snapshot.cash|default(0)) }}</dd>
        <dt class="col-6 text-muted">Position Value</dt>
        <dd class="col-6">${{ '%.2f'|format((snapshot.equity|default(0)) - (snapshot.cash|default(0))) }}</dd>
        <dt class="col-6 text-muted">Mode</dt>
        <dd class="col-6">{{ 'Simulated account' if snapshot.simulated else env.mode_label }}</dd>
      </dl>
      {% if snapshot.error %}
      <div class="alert alert-warning mt-3 mb-0" role="alert">
        {{ snapshot.error }}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="col-12 col-xl-8">
    <div class="card card-surface p-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div class="d-flex align-items-center gap-2">
          <h5 class="fw-semibold mb-0">Active positions</h5>
          {% if snapshot.simulated %}
          <span class="badge bg-info-subtle text-info-emphasis">Simulation</span>
          {% endif %}
        </div>
        {% if snapshot.positions %}
        <button type="button" class="btn btn-outline-danger btn-sm js-sell-all">Sell all</button>
        {% endif %}
      </div>
      {% if message %}
      <div class="alert alert-{{ 'danger' if status == 'error' else 'success' }}" role="alert">
        {{ message }}
      </div>
      {% endif %}
      <small class="text-muted d-block mb-3">Manual sells are logged to the system Log (success or failure).</small>
      <div class="table-responsive">
        <table class="table table-modern positions-table align-middle mb-0">
          <thead class="text-uppercase small text-muted">
            <tr>
              <th>Symbol</th>
              <th class="text-end">Quantity</th>
              <th class="text-end">Avg price</th>
              <th class="text-end">Last</th>
              <th class="text-end">Market value</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for pos in snapshot.positions %}
            <tr>
              <td class="fw-semibold">{{ pos.symbol }}</td>
              <td class="text-end">{{ '%.4f'|format(pos.qty) }}</td>
              <td class="text-end">${{ '%.2f'|format(pos.avg_price) }}</td>
              <td class="text-end">${{ '%.2f'|format(pos.current_price) }}</td>
              <td class="text-end">${{ '%.2f'|format(pos.market_value) }}</td>
              <td class="text-end">
                <button type="button" class="btn btn-outline-danger btn-sm js-sell" data-symbol="{{ pos.symbol }}">Sell</button>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">No active positions.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
async function refreshPositions() {
  window.location.reload();
}

async function postJSON(url, body) {
  const res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(body || {}),
  });
  let data = {};
  try {
    data = await res.json();
  } catch (err) {
    data = {};
  }
  if (!res.ok) {
    const err = new Error(data.message || res.statusText || "Request failed");
    err.data = data;
    throw err;
  }
  return data;
}

document.addEventListener("click", async (event) => {
  const target = event.target;
  if (target.matches(".js-sell")) {
    const symbol = target.dataset.symbol;
    if (!symbol) {
      alert("Sell: missing symbol");
      return;
    }
    target.disabled = true;
    try {
      const data = await postJSON("/positions/sell", { symbol });
      const message = data.message || `Sell ${symbol}: ${data.ok ? "submitted" : "failed"}`;
      alert(message);
      await refreshPositions();
    } catch (error) {
      const serverMessage = (error.data && error.data.message) || error.message;
      alert(`Sell ${symbol}: ${serverMessage}`);
      await refreshPositions();
    } finally {
      target.disabled = false;
    }
  }

  if (target.matches(".js-sell-all")) {
    if (!confirm("Close ALL positions? This will submit market orders.")) {
      return;
    }
    target.disabled = true;
    try {
      const data = await postJSON("/positions/sell_all");
      const message = data.message || (data.ok ? "Sell all: submitted" : "Sell all: failed");
      alert(message);
      await refreshPositions();
    } catch (error) {
      const serverMessage = (error.data && error.data.message) || error.message;
      alert(`Sell all: ${serverMessage}`);
      await refreshPositions();
    } finally {
      target.disabled = false;
    }
  }
});
</script>
{% endblock %}
