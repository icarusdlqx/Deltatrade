{% extends "base.html" %}

{% block title %}Positions · Deltatrade{% endblock %}
{% block header_title %}Portfolio positions{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-12 col-xl-4">
    <div class="card card-surface p-4 h-100">
      <h5 class="fw-semibold">Exposure snapshot</h5>
      <p class="text-muted small mb-4">Latest equity snapshot refreshed from the trading client.</p>
      <dl class="row small mb-0">
        <dt class="col-6 text-muted">Total Account Value</dt>
        <dd class="col-6 fw-bold">${{ '%.2f'|format(snapshot.equity|default(0)) }}</dd>
        <dt class="col-6 text-muted">Available Cash</dt>
        <dd class="col-6">${{ '%.2f'|format(snapshot.cash|default(0)) }}</dd>
        <dt class="col-6 text-muted">Position Value</dt>
        <dd class="col-6">${{ '%.2f'|format((snapshot.equity|default(0)) - (snapshot.cash|default(0))) }}</dd>
        <dt class="col-6 text-muted">Mode</dt>
        <dd class="col-6">{{ 'Simulated account' if snapshot.simulated else env.mode_label }}</dd>
      </dl>
      {% if snapshot.error %}
      <div class="alert alert-warning mt-3 mb-0" role="alert">
        {{ snapshot.error }}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="col-12 col-xl-8">
    <div class="card card-surface p-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
          <div class="d-flex align-items-center gap-2">
            <h5 class="fw-semibold mb-0">Active positions</h5>
            {% if snapshot.simulated %}
            <span class="badge bg-info-subtle text-info-emphasis">Simulation</span>
            {% endif %}
          </div>
          {% if snapshot.positions %}
        <button type="button" class="btn btn-outline-danger btn-sm js-sell-all">Sell all</button>
        {% endif %}
      </div>
      {% if message %}
      <div class="alert alert-{{ 'danger' if status == 'error' else 'success' }}" role="alert">
        {{ message }}
      </div>
      {% endif %}
      <div class="table-responsive">
        <table class="table table-modern positions-table align-middle mb-0">
          <thead class="text-uppercase small text-muted">
            <tr>
              <th>Symbol</th>
              <th class="text-end">Quantity</th>
              <th class="text-end">Avg price</th>
              <th class="text-end">Last</th>
              <th class="text-end">Market value</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for pos in snapshot.positions %}
            <tr>
              <td class="fw-semibold">{{ pos.symbol }}</td>
              <td class="text-end">{{ '%.6f'|format(pos.qty) }}</td>
              <td class="text-end">${{ '%.2f'|format(pos.avg_price) }}</td>
              <td class="text-end">${{ '%.2f'|format(pos.current_price) }}</td>
              <td class="text-end">${{ '%.2f'|format(pos.market_value) }}</td>
              <td class="text-end">
                <button type="button" class="btn btn-outline-danger btn-sm js-sell" data-symbol="{{ pos.symbol }}">Sell</button>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">No active positions.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <small class="text-muted d-block mt-3">Manual sells are logged to the system Log (success or failure).</small>
    </div>
  </div>
</div>
<script>
async function refreshPositions() {
  location.reload();
}

async function postJSON(url, body) {
  const response = await fetch(url, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(body || {}),
  });
  let data;
  try {
    data = await response.json();
  } catch (err) {
    throw new Error("Unable to parse server response");
  }
  if (!response.ok) {
    const message = (data && data.message) || response.statusText || "Request failed";
    const error = new Error(message);
    error.payload = data;
    throw error;
  }
  return data;
}

document.addEventListener("click", async (event) => {
  if (event.target.matches(".js-sell")) {
    const button = event.target;
    const symbol = button.dataset.symbol;
    button.disabled = true;
    try {
      const data = await postJSON("/positions/sell", {symbol});
      const message = data.message || (data.ok ? `Sell ${symbol}: submitted.` : `Sell ${symbol}: failed.`);
      alert(message);
      await refreshPositions();
    } catch (err) {
      alert(`Sell ${symbol}: error — ${err.message}`);
      console.error(err);
    } finally {
      button.disabled = false;
    }
  }

  if (event.target.matches(".js-sell-all")) {
    const button = event.target;
    if (!confirm("Close ALL positions? This will submit market orders.")) {
      return;
    }
    button.disabled = true;
    try {
      const data = await postJSON("/positions/sell_all", {});
      const message = data.message || (data.ok ? "Sell all: submitted." : "Sell all: failed.");
      alert(message);
      await refreshPositions();
    } catch (err) {
      alert(`Sell all: error — ${err.message}`);
      console.error(err);
    } finally {
      button.disabled = false;
    }
  }
});
</script>
{% endblock %}
