<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Deltatrade V1 · Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 6px 0; }
    form { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px; align-items:end;}
    .group { border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
    label { display:block; font-weight:600; margin-bottom:4px; }
    input, select { width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; }
    .row { display:flex; align-items:center; gap:8px; }
    .btn { display:inline-block; padding:10px 14px; background:#111827; color:#fff; border-radius:8px; text-decoration:none; }
    .note { color:#555; font-size:0.9em; }
  </style>
</head>
<body>
  <h1>Deltatrade V1 · Settings</h1>
  <p class="note">Overrides persist to <code>data/settings_overrides.json</code> and are picked up by the scheduler on the next loop.</p>
  <form method="post">
    <div class="group">
      <label><input type="checkbox" name="AUTOMATION_ENABLED" {% if cfg.AUTOMATION_ENABLED %}checked{% endif %}> Automation enabled</label>
      <label><input type="checkbox" name="DRY_RUN" {% if cfg.DRY_RUN %}checked{% endif %}> Dry run (no orders)</label>
      <label><input type="checkbox" name="ENABLE_EVENT_SCORE" {% if cfg.ENABLE_EVENT_SCORE %}checked{% endif %}> Use event/news alpha</label>
      <label><input type="checkbox" name="ENABLE_COST_GATE" {% if cfg.ENABLE_COST_GATE %}checked{% endif %}> Cost gate on</label>
      <label><input type="checkbox" name="ENABLE_VOL_TARGETING" {% if cfg.ENABLE_VOL_TARGETING %}checked{% endif %}> Vol targeting on</label>
    </div>

    <div class="group">
      <label>Trading windows (ET, comma‑sep)</label>
      <input name="TRADING_WINDOWS_ET" value="{{ ','.join(cfg.TRADING_WINDOWS_ET) }}">
      <label>Window tolerance (min)</label>
      <input name="WINDOW_TOL_MIN" type="number" step="1" value="{{ cfg.WINDOW_TOL_MIN }}">
      <label>Avoid near close (min)</label>
      <input name="AVOID_NEAR_CLOSE_MIN" type="number" step="1" value="{{ cfg.AVOID_NEAR_CLOSE_MIN }}">
    </div>

    <div class="group">
      <label>Universe mode</label>
      <select name="UNIVERSE_MODE">
        <option value="etfs_only" {% if cfg.UNIVERSE_MODE=='etfs_only' %}selected{% endif %}>ETFs only (default)</option>
        <option value="sp500_etfs" {% if cfg.UNIVERSE_MODE=='sp500_etfs' %}selected{% endif %}>S&P500 + ETFs (requires data/sp500.csv)</option>
      </select>
      <label>Universe max</label>
      <input name="UNIVERSE_MAX" type="number" step="1" value="{{ cfg.UNIVERSE_MAX }}">
      <label>Data lookback days</label>
      <input name="DATA_LOOKBACK_DAYS" type="number" step="1" value="{{ cfg.DATA_LOOKBACK_DAYS }}">
      <label>Min bars</label>
      <input name="MIN_BARS" type="number" step="1" value="{{ cfg.MIN_BARS }}">
    </div>

    <div class="group">
      <label>Event top‑K</label>
      <input name="EVENT_TOP_K" type="number" step="1" value="{{ cfg.EVENT_TOP_K }}">
      <label>News lookback (days)</label>
      <input name="NEWS_LOOKBACK_DAYS" type="number" step="1" value="{{ cfg.NEWS_LOOKBACK_DAYS }}">
      <label>Event alpha multiplier</label>
      <input name="EVENT_ALPHA_MULT" type="number" step="0.1" value="{{ cfg.EVENT_ALPHA_MULT }}">
    </div>

    <div class="group">
      <label>Target portfolio vol (ann.)</label>
      <input name="TARGET_PORTFOLIO_VOL" type="number" step="0.01" value="{{ cfg.TARGET_PORTFOLIO_VOL }}">
      <label>Risk aversion (lambda)</label>
      <input name="LAMBDA_RISK" type="number" step="0.1" value="{{ cfg.LAMBDA_RISK }}">
      <label>Turnover penalty</label>
      <input name="TURNOVER_PENALTY" type="number" step="0.0001" value="{{ cfg.TURNOVER_PENALTY }}">
      <label>Name max weight</label>
      <input name="NAME_MAX" type="number" step="0.01" value="{{ cfg.NAME_MAX }}">
      <label>Sector max weight</label>
      <input name="SECTOR_MAX" type="number" step="0.01" value="{{ cfg.SECTOR_MAX }}">
      <label>Rebalance band</label>
      <input name="REBALANCE_BAND" type="number" step="0.01" value="{{ cfg.REBALANCE_BAND }}">
      <label>Target positions</label>
      <input name="TARGET_POSITIONS" type="number" step="1" value="{{ cfg.TARGET_POSITIONS }}">
      <label>Cash buffer</label>
      <input name="CASH_BUFFER" type="number" step="0.01" value="{{ cfg.CASH_BUFFER }}">
    </div>

    <div class="group">
      <label>Sleeve weight — cross‑sectional</label>
      <input name="SLEEVE_XSEC" type="number" step="0.05" value="{{ cfg.SLEEVE_WEIGHTS['xsec'] }}">
      <label>Sleeve weight — event</label>
      <input name="SLEEVE_EVENT" type="number" step="0.05" value="{{ cfg.SLEEVE_WEIGHTS['event'] }}">
    </div>

    <div class="group">
      <label>Min order notional ($)</label>
      <input name="MIN_ORDER_NOTIONAL" type="number" step="1" value="{{ cfg.MIN_ORDER_NOTIONAL }}">
      <label>Max slices</label>
      <input name="MAX_SLICES" type="number" step="1" value="{{ cfg.MAX_SLICES }}">
      <label>Limit slip (bp)</label>
      <input name="LIMIT_SLIP_BP" type="number" step="1" value="{{ cfg.LIMIT_SLIP_BP }}">
      <label>Cost spread (bp)</label>
      <input name="COST_SPREAD_BPS" type="number" step="0.1" value="{{ cfg.COST_SPREAD_BPS }}">
      <label>Impact kappa</label>
      <input name="COST_IMPACT_KAPPA" type="number" step="0.01" value="{{ cfg.COST_IMPACT_KAPPA }}">
      <label>Impact psi</label>
      <input name="COST_IMPACT_PSI" type="number" step="0.1" value="{{ cfg.COST_IMPACT_PSI }}">
      <label>Fill timeout (sec)</label>
      <input name="FILL_TIMEOUT_SEC" type="number" step="1" value="{{ cfg.FILL_TIMEOUT_SEC }}">
    </div>

    <div class="group">
      <label>ATR stop ×</label>
      <input name="ATR_STOP_MULT" type="number" step="0.1" value="{{ cfg.ATR_STOP_MULT }}">
      <label>Take profit × ATR</label>
      <input name="TAKE_PROFIT_ATR" type="number" step="0.1" value="{{ cfg.TAKE_PROFIT_ATR }}">
      <label>Time stop (days)</label>
      <input name="TIME_STOP_DAYS" type="number" step="1" value="{{ cfg.TIME_STOP_DAYS }}">
    </div>

    <div style="grid-column:1/-1;">
      <button class="btn" type="submit">Save settings</button>
      <a class="btn" href="{{ url_for('dashboard') }}" style="background:#374151;">Back to dashboard</a>
      <p class="note">Active overrides (JSON):</p>
      <pre>{{ ov | tojson(indent=2) }}</pre>
    </div>
  </form>
</body>
</html>
